<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>E-LegalBoom | Intake Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Main site stylesheet (existing) -->
  <link rel="stylesheet" href="style.css" />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ðŸ”‘ REPLACE THESE WITH YOUR REAL VALUES
    const SUPABASE_URL = "https://vvjbjfltqsivvxxifnvi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2amJqZmx0cXNpdnZ4eGlmbnZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5NzYzNTAsImV4cCI6MjA3MzU1MjM1MH0.F4zzcpCHl9v-Rnj0wgKJ5zBf1HteVyXelMLQDDEN28Q";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>

  <!-- Intake-page-specific styles (light, modern card look) -->
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #f4f5fb;
      color: #1f2933;
    }

    .site-header {
      background: #111827;
      color: #f9fafb;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .site-header .brand {
      font-weight: 700;
      font-size: 1.1rem;
    }

    .site-header nav a {
      color: #e5e7eb;
      margin-left: 18px;
      text-decoration: none;
      font-size: 0.92rem;
    }

    .site-header nav a:hover {
      color: #ffffff;
      text-decoration: underline;
    }

    .intake-main {
      padding: 24px 12px 40px;
    }

    .intake-container {
      max-width: 960px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      padding: 28px 24px 32px;
    }

    .intake-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 20px;
    }

    .intake-header h1 {
      margin: 0 0 4px;
      font-size: 1.6rem;
    }

    .intake-header p {
      margin: 0;
      font-size: 0.95rem;
      color: #4b5563;
      max-width: 520px;
    }

    .pill-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      background: #eef2ff;
      color: #1f2937;
      border: 1px solid #e5e7eb;
    }

    .pill-label {
      font-weight: 600;
      margin-right: 4px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-size: 0.72rem;
      color: #4b5563;
    }

    .section {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px 18px 18px;
      margin-bottom: 16px;
      border: 1px solid #e5e7eb;
    }

    .section h2 {
      margin: 0 0 4px;
      font-size: 1.02rem;
    }

    .section small {
      font-size: 0.82rem;
      color: #6b7280;
    }

    .field-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px 16px;
      margin-top: 12px;
    }

    .field {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
    }

    .field label {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .field span.hint {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 2px;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    select,
    textarea {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 9px 10px;
      font-size: 0.92rem;
      outline: none;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb22;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    .pill-checkbox-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .pill-checkbox {
      position: relative;
      display: inline-flex;
      align-items: center;
    }

    .pill-checkbox input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .pill-checkbox span {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 0.86rem;
      background: #fff;
      cursor: pointer;
      user-select: none;
    }

    .pill-checkbox input:checked + span {
      background: #2563eb;
      color: #ffffff;
      border-color: #2563eb;
    }

    .confirmations {
      margin-top: 10px;
      font-size: 0.85rem;
    }

    .confirmations label {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin-top: 6px;
    }

    .confirmations input[type="checkbox"] {
      margin-top: 2px;
    }

    .form-footer {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 18px;
    }

    .btn-primary {
      background: #2563eb;
      color: #ffffff;
      border: none;
      border-radius: 999px;
      padding: 11px 22px;
      font-size: 0.98rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.25);
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .error-banner {
      display: none;
      margin-top: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      background: #fee2e2;
      color: #991b1b;
      font-size: 0.86rem;
      border: 1px solid #fecaca;
    }

    .fine-print {
      font-size: 0.78rem;
      color: #6b7280;
    }

    @media (max-width: 640px) {
      .intake-container {
        border-radius: 0;
        box-shadow: none;
        padding: 20px 14px 28px;
      }
      .site-header {
        padding-inline: 14px;
      }
    }
  </style>
</head>

<body>
  <!-- Top nav -->
  <header class="site-header">
    <div class="brand">E-LegalBoom</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="catalog.html">Catalog</a>
      <a href="bundle.html">Bundles</a>
    </nav>
  </header>

  <main class="intake-main">
    <div class="intake-container">
      <div class="intake-header">
        <div>
          <h1>Client Intake</h1>
          <p>
            Please complete this intake form. Your responses will be used to prepare the framework
            of your legal document. You will review and approve the final version before it is used.
          </p>
          <p style="margin-top:4px;font-size:0.82rem;color:#6b7280;">
            Fields marked with * are required. Some options (management, dispute resolution, non-compete, etc.)
            may not apply to every document; you may leave them blank when not relevant.
          </p>
        </div>
        <div class="pill-row">
          <div class="pill" id="tierPill" style="display:none;">
            <span class="pill-label">Tier</span>
            <span id="tierLabel">T1</span>
          </div>
          <div class="pill" id="selectedDocPill" style="display:none;">
            <span class="pill-label">Selected</span>
            <span id="selectedDocTypeLabel">Document</span>
          </div>
        </div>
      </div>

      <form id="intakeForm">
        <!-- Hidden routing fields (for Supabase + payment routing) -->
        <input type="hidden" id="doc_type" name="doc_type" />
        <input type="hidden" id="tier" name="tier" />

        <!-- 1. Contact Information -->
        <section class="section">
          <h2>1. Contact Information</h2>
          <small>Tell us who should be listed as the primary client or signing party.</small>

          <div class="field-row">
            <div class="field">
              <label for="customer_name">Full Name *</label>
              <input type="text" id="customer_name" name="customer_name" required />
            </div>

            <div class="field">
              <label for="customer_email">Email Address *</label>
              <input type="email" id="customer_email" name="customer_email" required />
            </div>

            <div class="field">
              <label for="phone">Phone (optional)</label>
              <input type="tel" id="phone" name="phone" />
              <span class="hint">Helpful if we need a quick clarification.</span>
            </div>
          </div>
        </section>

        <!-- 2. Entity / Relationship -->
        <section class="section">
          <h2>2. Entity / Relationship Information</h2>
          <small>This identifies the business, trust, or relationship the document will cover.</small>

          <div class="field-row">
            <div class="field">
              <label for="entity_type">Entity Type *</label>
              <select id="entity_type" name="entity_type" required>
                <option value="">Select oneâ€¦</option>
                <option value="individual">Individual</option>
                <option value="partnership">Partnership</option>
                <option value="llc">LLC</option>
                <option value="corporation">Corporation</option>
                <option value="trust">Trust</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="field">
              <label for="governing_state">Governing State *</label>
              <select id="governing_state" name="governing_state" required>
                <option value="">Select stateâ€¦</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
              </select>
            </div>

            <div class="field">
              <label for="entity_name">Business / Trust / Entity Name</label>
              <input type="text" id="entity_name" name="entity_name" />
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label for="other_parties">
              Names of Other Parties / Members / Trustees / Partners (comma-separated)
            </label>
            <input type="text" id="other_parties" name="other_parties" />
          </div>
        </section>

        <!-- 3. Ownership, Management & Options -->
        <section class="section">
          <h2>3. Ownership, Management & Options</h2>
          <small>Answer what applies. You may leave non-relevant items blank.</small>

          <div class="field-row">
            <div class="field">
              <label for="ownership_split">Ownership / Capital Split</label>
              <input
                type="text"
                id="ownership_split"
                name="ownership_split"
                placeholder="Example: 60% / 40% between two partners"
              />
              <span class="hint">Short description of how ownership or capital is divided.</span>
            </div>

            <div class="field">
              <label for="profit_loss_split">Profit &amp; Loss Split</label>
              <input
                type="text"
                id="profit_loss_split"
                name="profit_loss_split"
                placeholder="If different from ownership split"
              />
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="management_model">Management Model</label>
              <select id="management_model" name="management_model">
                <option value="">Select oneâ€¦</option>
                <option value="managing_partner">Managing partner / manager-managed</option>
                <option value="vote_based">Vote-based authority</option>
                <option value="equal_authority">Equal authority</option>
                <option value="other">Other / custom (describe in notes)</option>
              </select>
            </div>

            <div class="field">
              <label for="decision_rules">Decision Rules</label>
              <input
                type="text"
                id="decision_rules"
                name="decision_rules"
                placeholder="Example: majority vote, unanimous for major changes"
              />
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label for="dissolution_terms">Exit / Dissolution Terms</label>
              <textarea
                id="dissolution_terms"
                name="dissolution_terms"
                placeholder="If someone wants to leave, sell, or wind down, what should happen?"
              ></textarea>
            </div>

            <div class="field">
              <label for="transfer_rules">Transfer / Sale of Interests</label>
              <textarea
                id="transfer_rules"
                name="transfer_rules"
                placeholder="Any rules for selling or transferring ownership interests?"
              ></textarea>
            </div>
          </div>

          <div class="field-row">
            <div class="field">
              <label>Non-compete / Non-solicit?</label>
              <select id="non_compete_option" name="non_compete_option">
                <option value="">No preference / not needed</option>
                <option value="light">Light protection (basic non-solicit)</option>
                <option value="standard">Standard non-compete &amp; non-solicit</option>
                <option value="strong">Stronger restrictions requested</option>
              </select>
            </div>

            <div class="field">
              <label>Dispute Resolution Preference</label>
              <select id="dispute_method" name="dispute_method">
                <option value="">No preference / not sure</option>
                <option value="mediation">Mediation first</option>
                <option value="arbitration">Binding arbitration</option>
                <option value="court">Court / litigation</option>
                <option value="step_process">
                  Step process (mediation â†’ arbitration / court)
                </option>
              </select>
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label>Capital Types (check all that may apply)</label>
            <div class="pill-checkbox-row">
              <label class="pill-checkbox">
                <input type="checkbox" name="capital_types" value="cash" />
                <span>Cash</span>
              </label>
              <label class="pill-checkbox">
                <input type="checkbox" name="capital_types" value="property" />
                <span>Property / equipment</span>
              </label>
              <label class="pill-checkbox">
                <input type="checkbox" name="capital_types" value="services" />
                <span>Services / sweat equity</span>
              </label>
              <label class="pill-checkbox">
                <input type="checkbox" name="capital_types" value="cryptocurrency" />
                <span>Cryptocurrency</span>
              </label>
              <label class="pill-checkbox">
                <input type="checkbox" name="capital_types" value="other" />
                <span>Other</span>
              </label>
            </div>
          </div>

          <div class="field" style="margin-top:12px;">
            <label>Optional Legal Clauses (check any youâ€™d like us to consider)</label>
            <div class="pill-checkbox-row">
              <label class="pill-checkbox">
                <input type="checkbox" name="special_clauses" value="buy_sell" />
                <span>Buy-Sell / Exit terms</span>
              </label>
              <label class="pill-checkbox">
                <input type="checkbox" name="special_clauses" value="ip" />
                <span>Intellectual Property ownership</span>
              </label>
              <label class="pill-checkbox">
                <input type="checkbox" name="special_clauses" value="confidentiality" />
                <span>Confidentiality / trade secrets</span>
              </label>
              <label class="pill-checkbox">
                <input type="checkbox" name="special_clauses" value="custom" />
                <span>Custom clause (describe in notes)</span>
              </label>
            </div>
          </div>
        </section>

        <!-- 4. Special Instructions & Confirmations -->
        <section class="section">
          <h2>4. Special Instructions & Confirmations</h2>

          <div class="field">
            <label for="special_notes">Special Instructions or Notes</label>
            <textarea
              id="special_notes"
              name="special_notes"
              placeholder="Anything else we should know about this document or situation?"
            ></textarea>
          </div>

          <div class="confirmations">
            <label>
              <input type="checkbox" name="confirm_accuracy" required />
              <span>
                I confirm that the information provided is accurate to the best of my knowledge.*
              </span>
            </label>

            <label>
              <input type="checkbox" name="confirm_no_legal_advice" required />
              <span>
                I understand this is not legal advice and no attorney-client relationship is created
                through E-LegalBoom.*
              </span>
            </label>
          </div>

          <div class="form-footer">
            <button type="submit" class="btn-primary">
              Submit &amp; Continue to Payment
            </button>
            <div class="fine-print">
              You will not be charged on this page. Weâ€™ll guide you through payment after you review
              your summary.
            </div>
          </div>

          <div id="submitError" class="error-banner">
            There was an error submitting your intake. Please try again. If the problem continues,
            contact support.
          </div>
        </section>
      </form>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const storedDocumentType = localStorage.getItem('document_type') || "";
      const docType = params.get("doc_type") || "";
      const tier = params.get("tier") || "";

      // Final document type to save (bundle overrides everything)
const documentTypeToSave = storedDocumentType || docType || "single";

      // Populate hidden fields
      const docTypeInput = document.getElementById("doc_type");
      const tierInput = document.getElementById("tier");
      if (docTypeInput) docTypeInput.value = docType;
      if (tierInput) tierInput.value = tier;

      // Show chips
      const tierPill = document.getElementById("tierPill");
      const tierLabel = document.getElementById("tierLabel");
      if (tier && tierPill && tierLabel) {
        tierLabel.textContent = tier;
        tierPill.style.display = "inline-flex";
      }

      const docPill = document.getElementById("selectedDocPill");
      const docLabel = document.getElementById("selectedDocTypeLabel");
      if (docType && docPill && docLabel) {
        docLabel.textContent = docType.replace(/_/g, " ");
        docPill.style.display = "inline-flex";
      }

      const form = document.getElementById("intakeForm");
      const errorBanner = document.getElementById("submitError");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (errorBanner) errorBanner.style.display = "none";

        const formData = new FormData(form);

        // Build full JSON payload (includes every field)
        const dataPayload = {};
        formData.forEach((value, key) => {
          if (dataPayload[key] !== undefined) {
            if (!Array.isArray(dataPayload[key])) {
              dataPayload[key] = [dataPayload[key]];
            }
            dataPayload[key].push(value);
          } else {
            dataPayload[key] = value;
          }
        });

        // Make sure doc_type and tier are included in the JSON blob as well
        dataPayload.doc_type = docType;
        dataPayload.tier = tier;

        // Top-level columns (only those that exist in public.document_requests)
        const row = {
          doc_type: docType || null,
          customer_name: formData.get("customer_name") || null,
          customer_email: formData.get("customer_email") || null,
          entity_type: formData.get("entity_type") || null,
          entity_name: formData.get("entity_name") || null,
          governing_state: formData.get("governing_state") || null,
          status: "intake_submitted",
          data: dataPayload
        };

        try {
          const { error } = await supabaseClient
            .from("document_requests")
            .insert([row]);

          if (error) {
            console.error("Supabase insert error:", error);
            if (errorBanner) errorBanner.style.display = "block";
            return;
          }

          // On success â†’ send to payment, with tier highlighted if available
          const redirectTier = tier || "";
          const url =
            "payment.html" +
            (redirectTier ? `?tier=${encodeURIComponent(redirectTier)}` : "");
          window.location.href = url;
        } catch (err) {
          console.error("Unexpected error submitting intake:", err);
          if (errorBanner) errorBanner.style.display = "block";
        }
      });
    });
  </script>
</body>
</html>
